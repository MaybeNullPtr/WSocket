# WebSocket-like Frame Protocol Specification

## 协议概述

这是一个基于WebSocket协议但有所修改的自定义帧协议，主要用于高效的数据传输和消息交换。该协议保留了WebSocket的核心概念，但简化了某些方面并移除了掩码(
Mask)要求，使其更适合内部系统通信或自定义应用场景。

## 协议版本

当前协议版本：1.0 (自定义实现)

## 帧格式

### 基本帧结构

每个帧由两部分组成：

1. 帧头 (2-10字节)

2. 负载数据 (可变长度)

### 帧头详细结构

2字节基础帧头

```text
 0                   1
 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|F|R|R|R| opcode| Payload len   |
|I|S|S|S|  (4)  |     (8)       |
|N|V|V|V|       |               |
| |1|2|3|       |               |
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
```

* FIN (1位): 表示是否为消息的最后一帧

    * 0: 还有后续帧

    * 1: 这是最后一帧

* RSV1, RSV2, RSV3 (各1位): 保留位，可用于协议扩展

    * RSV1: 常用作压缩标志

    * RSV2, RSV3: 保留供未来使用

* Opcode (4位): 帧类型标识

    * 0x0: 系统帧 (保留)

    * 0x1: 文本帧 (UTF-8编码)

    * 0x2: 二进制帧

    * 0x8: 连接关闭帧

    * 0x9: Ping帧

    * 0xA: Pong帧

    * 其他值: 保留

* Payload Length (8位): 负载长度指示器

    * 0-253: 实际负载长度

    * 254: 后续2字节表示负载长度 (0-65535)

    * 255: 后续8字节表示负载长度 (0-2^64-1)

### 扩展长度字段

当Payload Length值为254或255时，帧头会包含额外的长度字段：

* 对于254: 添加2字节无符号整数 (网络字节序)

* 对于255: 添加8字节无符号整数 (网络字节序)

## 帧类型详解

### 数据帧 (0x1, 0x2)

用于传输应用数据：

* 文本帧 (0x1): 包含UTF-8编码的文本数据

* 二进制帧 (0x2): 包含任意二进制数据

数据帧可以分片传输，通过FIN位标识是否结束。

### 控制帧 (0x8, 0x9, 0xA)

用于连接控制：

* 关闭帧 (0x8): 通知对端连接关闭

    * 负载前2字节为关闭状态码 (网络字节序)

    * 可选地包含UTF-8编码的关闭原因

* Ping帧 (0x9): 心跳检测或连接保活

    * 可包含应用数据

* Pong帧 (0xA): 对Ping帧的响应

    * 应包含与对应Ping帧相同的数据

## 协议流程

### 连接建立

本协议不定义连接建立过程，依赖于底层传输协议（如TCP）建立连接。

### 数据传输

1. 发送方将数据分割为一个或多个帧

2. 每帧设置适当的Opcode和FIN标志

3. 接收方按顺序重组帧，直到收到FIN标志为1的帧

### 连接关闭

1. 任一方发送关闭帧 (Opcode 0x8)

2. 接收方收到关闭帧后，应回复关闭帧确认

3. 双方关闭底层连接

### 心跳机制

1. 任一方可发送Ping帧 (Opcode 0x9)

2. 接收方应在合理时间内回复Pong帧 (Opcode 0xA)

3. 超时无响应可视为连接异常

## 错误处理

### 关闭状态码

| 状态码  | 名称                   | 描述   |
|:----:|----------------------|------|
| 1000 | CLOSE_NORMAL         | 正常关闭 |
| 1002 | CLOSE_PROTOCOL_ERROR | 协议错误 |
| 1011 | INTERNAL_ERROR       | 内部错误 |

### 协议违规处理

遇到以下情况应发送关闭帧(1002)并终止连接：

* 接收到未知操作码的帧

* 控制帧分片(FIN=0)

* 控制帧负载过长

* 长度字段与实际负载不匹配

## 与标准WebSocket的区别

1. 无掩码(Mask)字段: 本协议不要求对负载进行掩码处理

2. 长度字段处理: 使用不同的长度指示值(254/255 vs 126/127)

3. 保留位使用: 明确RSV1位可用于压缩标志

4. 状态码定义: 使用简化的状态码集合

## todo list

~~1. 增加压缩，完善握手阶段~~

